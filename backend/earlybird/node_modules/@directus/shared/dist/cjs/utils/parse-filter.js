"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseFilter = void 0;
const to_array_1 = require("./to-array");
const adjust_date_1 = require("./adjust-date");
const deep_map_1 = require("./deep-map");
function parseFilter(filter, accountability) {
    return deep_map_1.deepMap(filter, (val, key) => {
        var _a;
        if (val === 'true')
            return true;
        if (val === 'false')
            return false;
        if (val === 'null' || val === 'NULL')
            return null;
        if (['_in', '_nin', '_between', '_nbetween'].includes(String(key))) {
            if (typeof val === 'string' && val.includes(','))
                return val.split(',');
            else
                return to_array_1.toArray(val);
        }
        if (val && typeof val === 'string' && val.startsWith('$NOW')) {
            if (val.includes('(') && val.includes(')')) {
                const adjustment = (_a = val.match(/\(([^)]+)\)/)) === null || _a === void 0 ? void 0 : _a[1];
                if (!adjustment)
                    return new Date();
                return adjust_date_1.adjustDate(new Date(), adjustment);
            }
            return new Date();
        }
        if (val === '$CURRENT_USER')
            return (accountability === null || accountability === void 0 ? void 0 : accountability.user) || null;
        if (val === '$CURRENT_ROLE')
            return (accountability === null || accountability === void 0 ? void 0 : accountability.role) || null;
        return val;
    });
}
exports.parseFilter = parseFilter;
